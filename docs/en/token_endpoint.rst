.. include:: ../common/common_definitions.rst


Token Endpoint
--------------

At the end of the authentication flow described at the previous section, the RP sends a request to the Token Endpoint with the authorization code received by the OP.

The Token response, if succesfull, returns an *ID Token*, an *Access Token* and possibly a *Refresh Token* (if a `long revocable session`_ has been started).

In a `long revocable session`_, the RP MAY call the *Token Endpoint* sending a *Refresh Token* in its possession, for obtaining a new *Access Token* and a new *ID Token*.

.. note::
  The authentication method of the RP by the Token Endpoint is the **private_key_jwt** (`OpenID.Core#ClientAuthentication`_)


.. seealso:: 

 * https://tools.ietf.org/html/rfc6749#section-3.2
 * https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint
 * https://openid.net/specs/openid-igov-oauth2-1_0-03.html#Section-2.1.2 
 * https://openid.net/specs/openid-igov-openid-connect-1_0-03.html#Section-2.2
 

Request
+++++++

The claims that MUST be included in the *Token Request* are given below.

**Request example with authorization code (case 1)**

  .. code-block:: http

    POST /token?
    client_id=https://rp.spid.agid.gov.it&
    client_assertion=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiw
    ibmFtZSI6IlNQSUQiLCJhZG1pbiI6dHJ1ZX0.LVyRDPVJm0S9q7oiXcYVIIqGWY0wWQlqxvFGYswL…&
    client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwtbearer&
    code=usDwMnEzJPpG5oaV8x3j&
    code_verifier=9g8S40MozM3NSqjHnhi7OnsE38jklFv2&
    grant_type=authorization_code

    Host: https://op.spid.agid.gov.it
    HTTP/1.1


.. seealso::

  - https://openid.net/specs/openid-connect-core-1_0.html#RPAuthentication

**Request example with Refresh Token (case 2):**

  .. code-block:: http

    POST /token?
    client_id=https://rp.spid.agid.gov.it&
    client_assertion=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiw
    ibmFtZSI6IlNQSUQiLCJhZG1pbiI6dHJ1ZX0.LVyRDPVJm0S9q7oiXcYVIIqGWY0wWQlqxvFGYswL…&
    client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwtbearer&
    grant_type=refresh_token&
    refresh_token=8xLOxBtZp8

    Host: https://op.spid.agid.gov.it
    HTTP/1.1

 
.. list-table:: 
   :widths: 20 60 20
   :header-rows: 1

   * - **Claim**
     - **Description**
     - **Supported by**
   * - **client_id**
     - See `OpenID.Registration`_. It MUST contain an HTTPS URL that uniquely identifies the RP.
     - |spid-icon| |cieid-icon|
   * - **client_assertion**
     - JWT signed with the Relying Party's private key containing the following parameters:
	 
	 **iss**: This MUST contain the *client_id*.
	 
	 **sub**: This MUST contain the *iss*.
	 
	 **aud**: URL of the OP Token Endpoint.
	 
	 **iat**: UNIX Timestamp with the time of the JWT generation, coded as NumericDate as indicated in :rfc:`7519`. 
	 
	 **exp**: UNIX Timestamp with the expiry time of the JWT, coded as NumericDate as indicated in :rfc:`7519`. 
	 
	 **jti**: Unique Identifier uuid4 for this authentication request, generated by the client. Eg: it can be in *uuid4* format.
     - |spid-icon| |cieid-icon|
   * - **client_assertion_type**
     - It must get the following value: |br|
       **urn:ietf:params:oauth:client-assertion-type:jwtbearer**.
     - |spid-icon| |cieid-icon|
   * - **code**
     - Authorization code returned in the Authentication Response. Required only if **grant_type** is **authorization_code**.
     - |spid-icon| |cieid-icon|
   * - **code_verifier**
     - Verification code of the code_challenge. Required only if **grant_type** is **authorization_code**.
     - |spid-icon| |cieid-icon|
   * - **grant_type**
     - Type of credentials, presented by the RP, for the current request.
       It MAY get one of the following values:
	 
	   - **authorization_code**
	   - **refresh_token**

     - |spid-icon| |cieid-icon|
   * - **refresh_token**
     - Required only if **grant_type** is **refresh_code**.
     - |spid-icon| |cieid-icon|
 
 
Response
++++++++

The OpenID Provider (OP) returns an ID Token, an Access Token and possibly a Refresh Token.

The Access Token must be formed according to the standard indications of the `"International Government Assurance Profile (iGov) for OAuth 2.0 - Draft 03", section 3.2.1, "JWT Bearer Tokens" <https://openid.net/specs/openid-igov-oauth2-1_0-03.html#Section-3.2.1>`_.

The ID Token must be formed according to the indications contained in the next section.

The response MUST contain the following claims.


**Response example:**

.. code-block:: http

  HTTP/1.1 200 OK
  Last-Modified: Wed, 22 Jul 2018 19:15:56 GMT
  Content-Type: application/json

  {
      "access_token":"dC34Pf6kdG...",
      "token_type":"Bearer",
      "refresh_token":"wJ848BcyLP...",
      "expires_in":1800,
      "id_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY..."
  }
 
.. list-table:: 
   :widths: 20 60 20
   :header-rows: 1

   * - **Claim**
     - **Description**
     - **Supported by**
   * - **access_token**
     - The Access Token, in signed JWT format, allows accessing the UserInfo Endpoint for obtaining the attributes.
     - |spid-icon| |cieid-icon|
   * - **token_type**
     - Type of *Access Token* returned. It MUST always be equal to **Bearer**.
     - |spid-icon| |cieid-icon|
   * - **refresh_token**
     - Available only in case of `long revocable session`_. The *Refresh Token* MUST be a signed JWT format. It allows calling again the *Token Endpoint* for obtaining a new *Access Token* and a new *ID Token*.
     - |spid-icon| |cieid-icon|
   * - **expires_in**
     - Expity time of the *Access Token* in seconds.
     - |spid-icon| |cieid-icon|
   * - **id_token**
     - ID Token in JWT format (see next section).
     - |spid-icon| |cieid-icon|


Access Token
++++++++++++

The Access Token is a JSON Web Token (JWT) that allows access to the
UserInfo endpoint to get user attributes.

**Access Token header and payload example:**

.. code-block:: json

  {
    "alg": "RS256",
    "kid": "dB67gL7ck3TFiIAf7N6_7SHvqk0MDYMEQcoGGlkUAAw",
    "type": "at+jwt"
  }
  .
  {
    "iss":"https://op.spid.agid.gov.it/",
    "sub": "9sd798asd98asui23hiuds89y798sfyg",
    "aud": [
    "https://rp.spid.example.it"
    ],
    "client_id": "https://rp.spid.example.it",
    "scope": "openid",
    "jti": "9ea42af0-594c-4486-9602-8a1f8dde42d3",
    "exp": 1656859559,
    "iat": 1656857579
  }


.. list-table:: 
   :widths: 20 60 20
   :header-rows: 1

   * - **Claim**
     - **Description**
     - **Supported by**
   * - **iss** 
     - It MUST be an HTTPS URL that uniquely identifies the OP. The client MUST verify that this value matches the called OP.
     - |spid-icon| |cieid-icon|
   * - **sub** 
     - See `OpenID.Core#SubjectIDTypes`_. It MUST be *pairwise*. 
     - |spid-icon| |cieid-icon|
   * - **aud** 
     - It MUST match the value *client_id*. The RP MUST verify that this value matches its client ID.
     - |spid-icon| |cieid-icon|
   * - **iat** 
     - UNIX Timestamp with the time of JWT generation, coded as NumericDate as indicated in :rfc:`7519`. 
     - |spid-icon| |cieid-icon|
   * - **exp**
     - UNIX Timestamp with the expiry time of the JWT, coded as NumericDate as indicated in :rfc:`7519`.
     - |spid-icon| |cieid-icon|
   * - **jti** 
     - It MUST be a String in *uuid4* format. Unique Token ID identifier that the RP MAY use to prevent reuse by rejecting the Token ID if already processed.
     - |spid-icon| |cieid-icon|
   * - **nonce** 
     - See `OpenID.Core#AuthRequest`_. It MUST be a random string of at least 32 alphanumeric characters. This value MUST match the value sent by the RP in the authentication request.
     - |spid-icon| |cieid-icon|

ID Token
++++++++

The ID Token is a JSON Web Token (JWT) that contains information on the user that has executed the authentication. The RPs MUST validate the ID Token.

.. admonition:: |cieid-icon|

  The RP MAY require the ID Token to be encrypted (see the parameter *id_token_encrypted_response_alg* in the :ref:`RP Metadata <MetadataRP>`). 
  
  If the RP exposes in its metadata parameter **id_token_encrypted_response_alg** the OP MUST encrypt the ID Token.
  In this case the ID Token MUST be a **nested signed and encrypted JWT** containing the *cty* (Content-Type) parameter in the JOSE header configured to *JWT* (see :rfc:`7519#section-5.2`).

The claims available in the *ID Token* are given below.

**Example of header and pyaload of an ID Token:**

.. code-block:: json

  {
    "alg": "RS256",
    "kid": "dB67gL7ck3TFiIAf7N6_7SHvqk0MDYMEQcoGGlkUAAw"
  }
  .
  {
      "iss":"https://op.spid.agid.gov.it/",
      "sub":"9sd798asd98asui23hiuds89y798sfyg",
      "aud":"https://rp.spid.agid.gov.it/auth",
      "acr":"https://www.spid.gov.it/SpidL2",
      "at_hash":"qiyh4XPJGsOZ2MEAyLkfWqeQ",
      "iat":1519032969,
      "nbf":1519032969,
      "exp":1519033149,
      "jti":"nw4J0zMwRk4kRbQ53G7z",
      "nonce":"MBzGqyf9QytD28eupyWhSqMj78WNqpc2"
  }


.. list-table:: 
   :widths: 20 60 20
   :header-rows: 1

   * - **Claim**
     - **Description**
     - **Supported by**
   * - **iss** 
     - It MUST be an HTTPS URL that uniquely identifies the OP. The client MUST verify that this value matches the called OP.
     - |spid-icon| |cieid-icon|
   * - **sub** 
     - See `OpenID.Core#SubjectIDTypes`_. It MUST be *pairwise*. 
     - |spid-icon| |cieid-icon|
   * - **aud** 
     - It MUST match the value *client_id*. The RP MUST verify that this value matches its client ID.
     - |spid-icon| |cieid-icon|
   * - **acr** 
     - Effective authentication level. It MAY be equal or greater than the one requested by the client in the Authentication Request.
     - |spid-icon| |cieid-icon|
   * - **at_hash** 
     - See `OpenID.Core#CodeIDToken`_. The client MUST verify that this value matches the *Access Token* returned with the Token ID. 
     - |spid-icon| |cieid-icon|
   * - **iat** 
     - UNIX Timestamp with the time of JWT generation, coded as NumericDate as indicated in :rfc:`7519`. 
     - |spid-icon| |cieid-icon|
   * - **nbf** 
     - UNIX Timestamp. Time of the validity beginning of the JWT in NumericDate format, as indicated in :rfc:`7519`. MUST match with the value of **iat**.
     - |spid-icon| |cieid-icon|
   * - **exp**
     - UNIX Timestamp with the expiry time of the JWT, coded as NumericDate as indicated in :rfc:`7519`.
     - |spid-icon| |cieid-icon|
   * - **jti** 
     - It MUST be a String in *uuid4* format. Unique Token ID identifier that the RP MAY use to prevent reuse by rejecting the Token ID if already processed.
     - |spid-icon| |cieid-icon|
   * - **nonce** 
     - See `OpenID.Core#AuthRequest`_. It MUST be a random string of at least 32 alphanumeric characters. This value MUST match the value sent by the RP in the authentication request.
     - |spid-icon| |cieid-icon|


.. seealso::

 - https://openid.net/specs/openid-connect-core-1_0.html#IDToken
 - https://openid.net/specs/openid-igov-openid-connect-1_0-03.html#Section-3.1


.. _TOKEN_ENDPOINT_ERRORS:

Errors
------

.. list-table:: 
  :widths: 20 20 20 20
  :header-rows: 1

  * - **Claim**
    - **Description**
    - **HTTP Code**
    - **Supported by**

  * - *invalid_client*
    - Client authentication failed (e.g., unknown client_id, no client authentication included, or unsupported authentication method) |br| (:rfc:`6749#section-5.2`).
    - *401 Unauthorized*
    - |spid-icon| |cieid-icon|

  * - *unsupported_grant_type*
    - The grant_type parameter contains an incorrect value.
    - *400 Bad Request*
    - |spid-icon| |cieid-icon|

  * - *invalid_grant*
    - The grant_type, code, code_verifier, access_token parameters are not valid.
    - *400 Bad Request*
    - |spid-icon| |cieid-icon|

  * - *invalid_request*
    - The request is not valid due to the lack or incorrectness of one or more parameters.
    - *400 Bad Request*
    - |spid-icon| |cieid-icon|

  * - *server_error*
    - The OP encountered an internal problem.
    - *400 Bad Request*
    - |spid-icon| |cieid-icon|

  * - *temporarily_unavailable*
    - The OP encountered a temporary internal problem.
    - *400 Bad Request*
    - |spid-icon| |cieid-icon|
